VERSION 0.8
FROM scratch

apk-deps:
    FROM alpine:3.19.1
    WORKDIR /RobotCode2024/trajectory_native
    RUN apk add --no-cache --update grpc-dev protobuf-dev blas-dev lapack-dev tinyxml2-dev
    SAVE IMAGE --push ghcr.io/mechanical-advantage/vts-apk-deps:latest

ipopt:
    FROM +apk-deps
    RUN apk add --no-cache --update clang make patch gfortran
    RUN mkdir ipopt-mumps-build
    WORKDIR ipopt-mumps-build
    RUN wget -c https://github.com/coin-or-tools/ThirdParty-Mumps/archive/refs/tags/releases/3.0.5.tar.gz -O - | tar -xz
    WORKDIR ThirdParty-Mumps-releases-3.0.5
    RUN ./get.Mumps
    RUN CC=clang CXX=clang++ ./configure
    RUN CC=clang CXX=clang++ make -j8
    # Install to both system (for subsequent ipopt build) and installroot (to copy out as artifacts)
    RUN CC=clang CXX=clang++ make install
    RUN CC=clang CXX=clang++ make DESTDIR=/RobotCode2024/trajectory_native/ipopt-mumps-build/installroot install
    WORKDIR ..

    RUN wget -c https://github.com/coin-or/Ipopt/archive/refs/tags/releases/3.14.14.tar.gz -O - | tar -xz
    RUN mkdir Ipopt-releases-3.14.14/build
    WORKDIR Ipopt-releases-3.14.14/build
    RUN CC=clang CXX=clang++ ../configure
    RUN CC=clang CXX=clang++ make -j8
    RUN CC=clang CXX=clang++ make DESTDIR=/RobotCode2024/trajectory_native/ipopt-mumps-build/installroot install
    SAVE ARTIFACT /RobotCode2024/trajectory_native/ipopt-mumps-build/installroot
    SAVE IMAGE --push ghcr.io/mechanical-advantage/vts-ipopt:latest

casadi:
    FROM +apk-deps
    COPY +ipopt/installroot/usr/local /usr/local/
    RUN wget -c https://github.com/casadi/casadi/archive/refs/tags/3.6.4.tar.gz -O - | tar -xz
    RUN mkdir casadi-3.6.4/build
    WORKDIR casadi-3.6.4/build
    RUN apk add --no-cache --update clang make cmake
    RUN CC=clang CXX=clang++ cmake -DWITH_IPOPT=ON -DWITH_DEEPBIND=OFF -DWITH_BUILD_TINYXML=OFF ..
    RUN CC=clang CXX=clang++ make -j8
    RUN CC=clang CXX=clang++ make DESTDIR=$(pwd)/installroot install
    SAVE ARTIFACT installroot
    SAVE IMAGE --push ghcr.io/mechanical-advantage/vts-casadi:latest

trajoptlib:
    FROM +apk-deps
    COPY +ipopt/installroot/usr/local /usr/local/
    COPY +casadi/installroot/usr/local /usr/local/
    LET TRAJOPT_COMMIT=f6cf3d42359f6f41f311f848a4e7f51c3f88c2ca
    RUN wget -c https://github.com/SleipnirGroup/TrajoptLib/archive/$TRAJOPT_COMMIT.tar.gz -O - | tar -xz
    RUN mkdir TrajoptLib-$TRAJOPT_COMMIT/build
    WORKDIR TrajoptLib-$TRAJOPT_COMMIT/build
    # Use our CMakeLists.txt (uses system casadi install)
    RUN rm ../CMakeLists.txt
    COPY trajoptlib-CMakeLists.txt ../CMakeLists.txt
    RUN apk add --no-cache --update clang make cmake git
    RUN CC=clang CXX=clang++ cmake -DOPTIMIZER_BACKEND=casadi ..
    RUN CC=clang CXX=clang++ make -j8
    RUN CC=clang CXX=clang++ make DESTDIR=$(pwd)/installroot install
    SAVE ARTIFACT installroot
    SAVE IMAGE --push ghcr.io/mechanical-advantage/vts-trajoptlib:latest

dev-image:
    FROM +apk-deps
    COPY +ipopt/installroot/usr/local /usr/local/
    COPY +casadi/installroot/usr/local /usr/local/
    COPY +trajoptlib/installroot/usr/local /usr/local/
    RUN apk add --no-cache --update clang make cmake git gdb nlohmann-json fmt-dev
    ENV CC="clang"
    ENV CXX="clang++"
    SAVE IMAGE --push ghcr.io/mechanical-advantage/vts-dev-image:latest

vts:
    FROM +dev-image
    COPY src src
    COPY proto proto
    COPY CMakeLists.txt CMakeLists.txt
    RUN mkdir build
    WORKDIR build
    RUN CC=clang CXX=clang++ cmake ..
    RUN CC=clang CXX=clang++ make -j8
    EXPOSE 56328
    ENV GRPC_VERBOSITY=info
    ENTRYPOINT ["./trajectory_native"]
    SAVE IMAGE --push ghcr.io/mechanical-advantage/vts:latest

vts-all-platforms:
    BUILD --platform=linux/amd64 --platform=linux/arm64 +apk-deps
    BUILD --platform=linux/amd64 --platform=linux/arm64 +ipopt
    BUILD --platform=linux/amd64 --platform=linux/arm64 +casadi
    BUILD --platform=linux/amd64 --platform=linux/arm64 +trajoptlib
    BUILD --platform=linux/amd64 --platform=linux/arm64 +dev-image
    BUILD --platform=linux/amd64 --platform=linux/arm64 +vts